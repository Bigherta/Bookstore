# Bookstore总体设计文档

## 1. 项目基本信息

* **项目名称**：Bookstore 书店管理系统
* **文档作者**：黄厚盛（Cyrene）
* **开发语言**：C++
* **运行平台**：Windows / Linux 命令行终端
* **数据持久化方式**：二进制文件实时读写

---

## 2. 程序功能概述

本系统是一个命令行交互式书店管理系统，通过解析用户输入指令，对用户、图书及日志进行管理，实现以下核心功能：

### （1）帐户系统

* 注册、登录、创建、删除帐户
* 修改密码
* 维护多层嵌套的登录栈
* 权限控制（{7}, {3}, {1}, {0}）

### （2）图书系统

* 存储并维护图书信息（ISBN、书名、作者、关键词、价格、库存）
* 图书检索（支持多种检索方式）
* 图书购买、选择、修改信息
* 图书进货（数量+总额）

### （3）日志系统

* 财务日志记录（收入/支出）
* 员工操作日志记录
* 财务查询、操作记录查询
* 生成财务报表与员工报告

### （4）数据持久化

* 使用文件存储所有帐户、图书、日志数据
* 可在程序首次运行时自动初始化 root
* 持久化不依赖内存缓存，严格遵守实时读写要求

---

## 3. 主体逻辑说明

程序运行的主流程如下：

### （1）初始化阶段

1. 打开或创建用户数据文件、图书数据文件、日志文件
2. 若用户文件不存在，则自动创建 root 帐户：

   * UserID：`root`
   * Password：`sjtu`
   * Privilege：{7}
3. 初始化登录栈

### （2）指令解析阶段

* 读取用户输入一行
* 清理多余空格
* 将输入行拆分为tokens
* 识别指令关键词
* 按照标准文法解析参数，包括合法性检验

### （3）权限检查阶段

* 根据当前登录栈顶部的用户确定权限
* 若权限不足，指令失败 → 输出 `Invalid`

### （4）指令执行阶段

* 执行图书、日志的相关操作
* 每次更改均同步写回文件

### （5）循环运行阶段

* 程序持续读取指令直到 EOF 或指令要求退出
* `quit` / `exit`：正常退出（清空登录栈）

---

## 4. 代码文件结构

```
/include
    ├── Parser.hpp
    ├── Token.hpp
    ├── User.hpp
    ├── Book.hpp
    ├── Storage.hpp
    ├── Log.hpp
/src
    ├── main.cpp
    ├── Parser.cpp
    ├── User.cpp
    ├── Book.cpp
    ├── Storage.cpp
    ├── Log.cpp
/data (程序自动生成)
    ├── index      // 图书索引
    ├── information // 图书块状链表
    ├── log        // 系统日志
    
```

## 5. 系统模块设计

系统采用分层与模块化设计，模块之间通过清晰的接口交互。

### **总体结构图**

```
┌──────────────────────────────────────────────┐
│                   Main                       │
│   输入 → Parser → TokenStream → 调度模块       │
└───────────────┬──────────────────────────────┘
                │
 ┌──────────────┼──────────────────────────────┐
 │              │                              │
 ▼              ▼                              ▼
User模块       Book模块                    Log 模块
│              │                              │
│ 登录/注册     │ 图书增删改查、库存、检索       │ 财务/记录
│ 权限校验      │ 块状链表索引结构              │ 交易记录查询
│ 用户栈管理    │ 文件实时写入                  │ 报表输出
               └──────────────┬───────────────┘
                              ▼
                    Storage 文件存储层

```

### **模块职责说明**

#### （1）Main 模块

* 负责程序主循环
* 调用 Parser 对指令进行解析
* 进行权限检查并调度其他模块

#### （2）User 模块

* 用户结构体：UserID、Password、Privilege、Username
* 登录栈维护
* 注册、登录、删除、修改密码等操作

#### （3）Book 模块

* 定义图书信息结构：ISBN、BookName、Author、Keyword、Price、Stock
* 提供检索、选择、修改、购买、进货接口
* 负责图书索引结构与块状链表存储

#### （4）Log 模块

* 财务日志（收入、支出记录）
* 员工操作日志
* 提供查询、报表、记录生成

#### （5）Storage 模块

* 进行二进制文件读写
* 提供通用模板接口存储结构体
* 支持随机读写定位

### 功能结构图

```
Main
├── Parser
├── UserModule
│    ├── Register
│    ├── Login / Logout
│    ├── ModifyPassword
│    ├── UserAdd / Delete
├── BookModule
│    ├── Show
│    ├── Buy
│    ├── Select
│    ├── Modify
│    └── Import
└── LogModule
     ├── ShowFinance
     ├── ReportFinance
     ├── ReportEmployee
     └── Log
```
---

## 6. 数据库设计

### **（1）用户数据结构**

```

| 字段        | 类型       | 存储方式  | 说明       |
| ---------   | --------  | --------  | -------- |
| userID    | string   | 内存存储 | 用户 ID（唯一） |
| username  | string   | 内存存储 | 用户昵称 |
| password  | string   | 内存存储 | 密码 |
| privilegeLevel | int | 内存存储 | 权限等级（0/1/3/7） |
| log_status | bool    | 内存存储 | 是否当前登录 |

```

### **（2）图书数据结构** （包含块状链表与索引）

```

| 字段         | 类型       | 存储方式  | 说明      |
| ---------- | -------- | ----- | ------- |
| ISBN       | char[20] | 二进制文件 | 图书唯一编号  |
| BookName   | char[60] | 二进制文件 | 书名      |
| Author     | char[60] | 二进制文件 | 作者      |
| Keyword    | char[60] | 二进制文件 | 多关键词    |
| Price      | double   | 二进制文件 | 图书单价    |
| Stock      | int      | 二进制文件 | 库存      |
| next_block | int      | 二进制文件 | 链表指针    |
| size       | int      | 二进制文件 | 当前块图书数量 |

```

### **（3）日志数据结构**

文件名：`log`

存储结构体：

```cpp
struct record {
    int count;
    double income;
    double expense;
};

```

| 字段     | 类型   | 存储 | 说明 |
|----------|--------|------|------|
| count    | int    | 二进制文件 | 当前交易序号 |
| income   | double | 二进制文件 | 本次收入 |
| expense  | double | 二进制文件 | 本次支出 |

---

## 7.类与结构体设计

### (1)Token.hpp

- 设计目的：将原始文本与标识符绑定，以便识别指令关键词

```
struct Token
{
    TokenType type{TokenType::BLANK}; // 封装类型
    std::string text{}; // 封装原始文本
    int column{0}; // 追踪当前列
};
```

```

class TokenStream
{
public:
    TokenStream() = default; // 默认构造
    explicit TokenStream(std::vector<Token> &&tokens);

    const std::shared_ptr<Token> peek() const; // 获取当前Token

    const std::shared_ptr<Token> get(); // 获取当前Token后进行游标移动
   
    int size() const; //返回该行有多少个Token

    void push(Token &&token);

private:
    std::vector<Token> tokens_{};

    int cursor_{0};
};

```

### (2)parser.hpp

- 设计目的：将一行指令以单词为单位分成若干Tokens，以便后续处理

```

class Parser
{
public:
    TokenStream tokenize(const std::string &line) const; // 将一行源码进行语义分解
    TokenType matchkeyword(const std::string &text) const; // 将字符串匹配成对应的枚举类
    static bool isLetterChar(char ch) noexcept; // 判断是否是字母
    static bool isNumberChar(char ch) noexcept; // 判断是否是数字
};

```

### (3)user.hpp

```
struct user
{
    std::string userID; 
    std::string username;
    std::string password;
    int privilegeLevel = 0; // 0: visitor, 1: customer, 3: worker, 7: manager
    bool log_status = false;
};
```

```

class UserManager
{
public:
    UserManager();

    bool login(const std::string &userID_, const std::string &password_); // 登录帐户

    bool logout(); // 注销账户

    bool registerUser(const std::string &userID_, const std::string &password_, const std::string &username_); // 注册帐户

    bool passwd(const std::string &userID_, const std::string &cur_Password_, const std::string &new_Password_); // 修改密码

    bool useradd(const std::string &userID_, const std::string &password_, int privilegeLevel_,
                 const std::string &username_); // 创建帐户

    bool deleteUser(const std::string &userID_); // 删除帐户

    
private:
    std::unordered_map<std::string, user> userDatabase; // userID -> user的映射

    std::vector<user> logstack; // 登录栈

    user currentUser; //当前登录帐户
};

```