# Bookstore总体设计文档

## 1. 项目基本信息

* **项目名称**：Bookstore 书店管理系统
* **文档作者**：黄厚盛（Cyrene）
* **开发语言**：C++
* **运行平台**：Windows / Linux 命令行终端
* **数据持久化方式**：二进制文件实时读写

---

## 2. 程序功能概述

本系统是一个命令行交互式书店管理系统，通过解析用户输入指令，对用户、图书及日志进行管理，实现以下核心功能：

### （1）帐户系统

* 注册、登录、创建、删除帐户
* 修改密码
* 维护多层嵌套的登录栈
* 权限控制（{7}, {3}, {1}, {0}）

### （2）图书系统

* 存储并维护图书信息（ISBN、书名、作者、关键词、价格、库存）
* 图书检索（支持多种检索方式）
* 图书购买、选择、修改信息
* 图书进货（数量+总额）

### （3）日志系统

* 财务日志记录（收入/支出）
* 员工操作日志记录
* 财务查询、操作记录查询
* 生成财务报表与员工报告

### （4）数据持久化

* 使用文件存储所有帐户、图书、日志数据
* 可在程序首次运行时自动初始化 root
* 持久化不依赖内存缓存，严格遵守实时读写要求

---

## 3. 主体逻辑说明（补全流程 & 细化）

程序运行的主流程如下：

### （1）初始化阶段

1. 打开或创建用户数据文件、图书数据文件、日志文件
2. 若用户文件不存在，则自动创建 root 帐户：

   * UserID：`root`
   * Password：`sjtu`
   * Privilege：{7}
3. 初始化登录栈

### （2）指令解析阶段

* 读取用户输入一行
* 清理多余空格
* 识别指令关键词
* 按照标准文法解析参数，包括合法性检验

### （3）权限检查阶段

* 根据当前登录栈顶部的用户确定权限
* 若权限不足，指令失败 → 输出 `Invalid`

### （4）指令执行阶段

* 执行图书、日志的相关操作
* 每次更改均同步写回文件

### （5）循环运行阶段

* 程序持续读取指令直到 EOF 或指令要求退出
* `quit` / `exit`：正常退出（清空登录栈）

---

## 4. 系统模块设计

系统采用分层与模块化设计，模块之间通过清晰的接口交互。

### **总体结构图**

```
                    ┌───────────────────────┐
                    │      主程序模块 Main    │
                    └───────────┬────────────┘
                                │
            ┌───────────────────┼───────────────────┐
            │                   │                   │
            ▼                   ▼                   ▼
   ┌─────────────────┐  ┌─────────────────┐  ┌──────────────────┐
   │ 用户信息管理模块 │  │ 图书信息管理模块  │  │  系统日志管理模块 │
   │     User        │  │      Book       │  │       Log        │
   └────────┬────────┘  └────────┬────────┘  └──────────┬───────┘
            │                    │                       │
            └────────────────────┴───────────────────────┘
                                 ▼
                     ┌─────────────────────────┐
                     │     存储管理模块        │
                     │       Storage           │
                     └─────────────────────────┘
```

### **模块职责说明**

#### （1）Main 模块

* 负责程序主循环
* 调用 Parser 对指令进行解析
* 进行权限检查并调度其他模块

#### （2）User 模块

* 用户结构体：UserID、Password、Privilege、Username
* 登录栈维护
* 注册、登录、删除、修改密码等操作

#### （3）Book 模块

* 定义图书信息结构：ISBN、BookName、Author、Keyword、Price、Stock
* 提供检索、选择、修改、购买、进货接口
* 负责图书索引结构与块状链表存储

#### （4）Log 模块

* 财务日志（收入、支出记录）
* 员工操作日志
* 提供查询、报表、记录生成

#### （5）Storage 模块

* 进行二进制文件读写
* 提供通用模板接口存储结构体
* 支持随机读写定位

### 功能结构图

```
Main
├── Parser
├── UserModule
│    ├── Register
│    ├── Login / Logout
│    ├── ModifyPassword
│    ├── UserAdd / Delete
├── BookModule
│    ├── Show
│    ├── Buy
│    ├── Select
│    ├── Modify
│    └── Import
└── LogModule
     ├── ShowFinance
     ├── ReportFinance
     ├── ReportEmployee
     └── Log
```
---

## 5. 数据库设计

### **（1）用户数据结构**

| 字段        | 类型       | 存储方式  | 说明       |
| --------- | -------- | ----- | -------- |
| UserID    | char[30] | 内存存储 | 唯一键       |
| Password  | char[30] | 内存存储 | 密码         |
| Username  | char[30] | 内存存储 | 显示名称     |
| Privilege | int      | 内存存储 | 权限等级     |

### **（2）图书数据结构** （包含块状链表与索引）

| 字段         | 类型       | 存储方式  | 说明      |
| ---------- | -------- | ----- | ------- |
| ISBN       | char[20] | 二进制文件 | 图书唯一编号  |
| BookName   | char[60] | 二进制文件 | 书名      |
| Author     | char[60] | 二进制文件 | 作者      |
| Keyword    | char[60] | 二进制文件 | 多关键词    |
| Price      | double   | 二进制文件 | 图书单价    |
| Stock      | int      | 二进制文件 | 库存      |
| next_block | int      | 二进制文件 | 链表指针    |
| size       | int      | 二进制文件 | 当前块图书数量 |

### **（3）日志数据结构**

| 字段       | 类型        | 说明               |
| -------- | --------- | ---------------- |
| Type     | int       | 0=收入，1=支出，2=操作日志 |
| Amount   | double    | 金额                     |
| Operator | char[30]  | 执行指令的用户            |
| Command  | char[200] | 完整指令记录              |

---
